{% extends "base.html" %}

{% block title %}Laudo Ecocardiogr√°fico - {{ exame.nome_paciente }}{% endblock %}

{% block extra_css %}
<style>
.progress-indicator {
    background: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 2rem;
}

.progress-step {
    display: inline-flex;
    align-items: center;
    margin-right: 2rem;
    color: #6c757d;
}

.progress-step.active {
    color: #1e40af;
    font-weight: 600;
}

.progress-step.completed {
    color: #28a745;
}

.progress-step i {
    margin-right: 0.5rem;
}

.laudo-section {
    margin-bottom: 2rem;
}

.template-buttons {
    margin-bottom: 1rem;
}

.template-btn {
    margin: 0.25rem;
}

.char-counter {
    font-size: 0.8rem;
    color: #6c757d;
    text-align: right;
    margin-top: 0.25rem;
}

.laudo-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-top: 1rem;
}

.auto-save-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
}
</style>
{% endblock %}

{% block content %}
<!-- Auto-save indicator -->
<div id="auto-save-indicator" class="auto-save-indicator" style="display: none;">
    <div class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle me-1"></i>Salvamento autom√°tico realizado
    </div>
</div>

<!-- Progress Indicator -->
<div class="progress-indicator">
    <div class="d-flex flex-wrap">
        <div class="progress-step completed">
            <i class="fas fa-check-circle"></i>
            Dados do Paciente
        </div>
        <div class="progress-step completed">
            <i class="fas fa-check-circle"></i>
            Par√¢metros Ecocardiogr√°ficos
        </div>
        <div class="progress-step active">
            <i class="fas fa-file-medical"></i>
            Laudo M√©dico
        </div>
        <div class="progress-step">
            <i class="fas fa-file-pdf"></i>
            Relat√≥rio Final
        </div>
    </div>
</div>

<!-- Patient Info -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h4 class="text-primary mb-1">{{ exame.nome_paciente }}</h4>
                <p class="text-muted mb-0">
                    <i class="fas fa-user me-1"></i>{{ exame.sexo }} ‚Ä¢ 
                    <i class="fas fa-birthday-cake me-1"></i>{{ exame.idade }} anos ‚Ä¢ 
                    <i class="fas fa-calendar me-1"></i>Exame: {{ exame.data_exame }}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{{ url_for('parametros', id=exame.id) }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Voltar aos Par√¢metros
                </a>
            </div>
        </div>
    </div>
</div>

<form method="POST" id="laudo-form" action="{{ url_for('salvar_laudo', id=exame.id) }}">
    <!-- Templates de Laudo com Busca Avan√ßada -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-search-plus me-2"></i>Buscar Templates de Laudo
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="busca-laudo-diagnostico" 
                               placeholder="Digite diagn√≥stico ou patologia..."
                               autocomplete="off">
                        <label for="busca-laudo-diagnostico">
                            <i class="fas fa-stethoscope me-1"></i>Buscar por Diagn√≥stico
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <select class="form-select" id="categoria-laudo">
                            <option value="Adulto">Adulto</option>
                            <option value="Pedi√°trico">Pedi√°trico</option>
                        </select>
                        <label for="categoria-laudo">
                            <i class="fas fa-user-tag me-1"></i>Categoria
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-outline-secondary w-100 h-100" 
                            id="limpar-busca-laudo" style="margin-top: 8px;">
                        <i class="fas fa-times me-1"></i>Limpar
                    </button>
                </div>
            </div>
            
            <!-- Resultados da Busca -->
            <div id="resultados-busca-laudo" class="mt-3" style="display: none;">
                <div class="border rounded p-3 bg-light">
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-list-alt me-1"></i>Resultados Encontrados:
                    </h6>
                    <div id="lista-templates-laudo" class="row"></div>
                </div>
            </div>
            
            <!-- Template Selecionado -->
            <div id="template-selecionado" class="mt-3" style="display: none;">
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Template Selecionado:</strong> 
                            <span id="nome-template-selecionado"></span>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" id="aplicar-template">
                            <i class="fas fa-magic me-1"></i>Aplicar Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Personalizados -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="fas fa-file-medical me-2"></i>Templates Personalizados
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="busca-template-laudo" 
                               placeholder="Digite patologia ou nome do template...">
                        <label for="busca-template-laudo">Buscar Templates</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <select class="form-select" id="filtro-categoria-template">
                            <option value="">Todas as categorias</option>
                            <option value="Normal">Normal</option>
                            <option value="Cardiomiopatias">Cardiomiopatias</option>
                            <option value="Valvopatias">Valvopatias</option>
                            <option value="Altera√ß√µes Estruturais">Altera√ß√µes Estruturais</option>
                        </select>
                        <label for="filtro-categoria-template">Categoria</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-primary h-100 w-100" onclick="buscarTemplatesLaudo()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <div id="templates-encontrados" class="mt-3" style="max-height: 200px; overflow-y: auto;">
                <div class="text-center text-muted py-3">
                    <i class="fas fa-search fa-2x mb-2"></i>
                    <p>Digite para buscar templates personalizados</p>
                </div>
            </div>
            
            <div class="mt-3">
                <button type="button" class="btn btn-outline-success btn-sm" onclick="abrirGerenciadorTemplates()">
                    <i class="fas fa-cog me-1"></i>Gerenciar Templates
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="salvarComoTemplate()">
                    <i class="fas fa-save me-1"></i>Salvar como Template
                </button>
            </div>
        </div>
    </div>

    <!-- Modo M e Bidimensional -->
    <div class="card laudo-section">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-eye me-2"></i>Modo M e Bidimensional
            </h5>
        </div>
        <div class="card-body">
            <div class="template-buttons">
                <button type="button" class="btn btn-outline-info btn-sm template-btn" 
                        data-template="modo_m_normal">Normal</button>
                <button type="button" class="btn btn-outline-warning btn-sm template-btn" 
                        data-template="modo_m_alterado">Alterado</button>
                <button type="button" class="btn btn-outline-secondary btn-sm template-btn" 
                        data-template="modo_m_hipertrofia">Hipertrofia</button>
            </div>
            
            <div class="form-floating">
                <textarea class="form-control" id="modo_m_bidimensional" name="modo_m_bidimensional" 
                          style="height: 120px" maxlength="1000" data-auto-save="true">{{ laudo.modo_m_bidimensional if laudo else '' }}</textarea>
                <label for="modo_m_bidimensional">Descri√ß√£o do Modo M e Bidimensional</label>
            </div>
            <div class="char-counter">
                <span id="modo_m_count">0</span>/1000 caracteres
            </div>
        </div>
    </div>

    <!-- Doppler Convencional -->
    <div class="card laudo-section">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-wave-square me-2"></i>Doppler Convencional
            </h5>
        </div>
        <div class="card-body">
            <div class="template-buttons">
                <button type="button" class="btn btn-outline-info btn-sm template-btn" 
                        data-template="doppler_normal">Normal</button>
                <button type="button" class="btn btn-outline-warning btn-sm template-btn" 
                        data-template="doppler_disfuncao">Disfun√ß√£o Diast√≥lica</button>
                <button type="button" class="btn btn-outline-danger btn-sm template-btn" 
                        data-template="doppler_insuficiencia">Insufici√™ncias</button>
            </div>
            
            <div class="form-floating">
                <textarea class="form-control" id="doppler_convencional" name="doppler_convencional" 
                          style="height: 120px" maxlength="1000" data-auto-save="true">{{ laudo.doppler_convencional if laudo else '' }}</textarea>
                <label for="doppler_convencional">Descri√ß√£o do Doppler Convencional</label>
            </div>
            <div class="char-counter">
                <span id="doppler_count">0</span>/1000 caracteres
            </div>
        </div>
    </div>

    <!-- Doppler Tecidual -->
    <div class="card laudo-section">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-broadcast-tower me-2"></i>Doppler Tecidual
            </h5>
        </div>
        <div class="card-body">
            <div class="template-buttons">
                <button type="button" class="btn btn-outline-info btn-sm template-btn" 
                        data-template="tecidual_normal">Normal</button>
                <button type="button" class="btn btn-outline-warning btn-sm template-btn" 
                        data-template="tecidual_alterado">Alterado</button>
            </div>
            
            <div class="form-floating">
                <textarea class="form-control" id="doppler_tecidual" name="doppler_tecidual" 
                          style="height: 120px" maxlength="1000" data-auto-save="true">{{ laudo.doppler_tecidual if laudo else '' }}</textarea>
                <label for="doppler_tecidual">Descri√ß√£o do Doppler Tecidual</label>
            </div>
            <div class="char-counter">
                <span id="tecidual_count">0</span>/1000 caracteres
            </div>
        </div>
    </div>

    <!-- Conclus√£o -->
    <div class="card laudo-section">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="fas fa-clipboard-check me-2"></i>Conclus√£o
            </h5>
        </div>
        <div class="card-body">
            <div class="template-buttons">
                <button type="button" class="btn btn-outline-success btn-sm template-btn" 
                        data-template="conclusao_normal">Exame Normal</button>
                <button type="button" class="btn btn-outline-warning btn-sm template-btn" 
                        data-template="conclusao_alteracoes">Com Altera√ß√µes</button>
                <button type="button" class="btn btn-outline-info btn-sm template-btn" 
                        data-template="conclusao_acompanhamento">Acompanhamento</button>
            </div>
            
            <div class="form-floating">
                <textarea class="form-control" id="conclusao" name="conclusao" 
                          style="height: 150px" maxlength="2000" data-auto-save="true" required>{{ laudo.conclusao if laudo else '' }}</textarea>
                <label for="conclusao">Conclus√£o do Exame *</label>
            </div>
            <div class="char-counter">
                <span id="conclusao_count">0</span>/2000 caracteres
            </div>
        </div>
    </div>



    <!-- Preview Section -->
    <div class="card laudo-section">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-eye me-2"></i>Pr√©via do Laudo
            </h5>
        </div>
        <div class="card-body">
            <div class="laudo-preview" id="laudo-preview">
                <p class="text-muted text-center">A pr√©via ser√° exibida conforme voc√™ preenche os campos acima.</p>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-flex justify-content-between mt-4">
        <div>
            <button type="button" onclick="window.history.back()" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Voltar
            </button>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-1"></i>Salvar Laudo
            </button>
            <button type="button" onclick="salvarEGerarPDF({{ exame.id }})" class="btn btn-primary">
                <i class="fas fa-file-pdf me-1"></i>Salvar e Gerar PDF
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<!-- Sistema de Laudos JavaScript Nativo -->
<script src="{{ url_for('static', filename='js/laudo_system.js') }}"></script>
<script>
// Sistema de laudos com templates nativos - JavaScript puro
document.addEventListener('DOMContentLoaded', function() {
    console.log('Sistema de laudos inicializado');
    
    // Templates de texto pr√©-definidos
    const templates = {
        // Modo M templates
        modo_m_normal: "√Åtrio esquerdo e cavidades ventriculares com dimens√µes normais. Espessuras parietais dentro dos limites da normalidade. Fun√ß√£o sist√≥lica global do ventr√≠culo esquerdo preservada.",
        modo_m_alterado: "Altera√ß√µes nas dimens√µes cavit√°rias. Espessuras parietais aumentadas/diminu√≠das. Fun√ß√£o sist√≥lica global do ventr√≠culo esquerdo prejudicada/preservada.",
        modo_m_hipertrofia: "Hipertrofia conc√™ntrica/exc√™ntrica do ventr√≠culo esquerdo. Espessura do septo interventricular e parede posterior aumentadas.",
        
        // Doppler templates
        doppler_normal: "Fluxo transmitral com padr√£o normal de enchimento ventricular. Velocidades e gradientes transvalvares dentro dos limites da normalidade.",
        doppler_disfuncao: "Padr√£o de disfun√ß√£o diast√≥lica grau I/II/III. Altera√ß√£o do relaxamento ventricular com invers√£o da rela√ß√£o E/A.",
        doppler_insuficiencia: "Insufici√™ncia mitral/tric√∫spide/a√≥rtica/pulmonar de grau leve/moderado/grave. Gradientes press√≥ricos elevados.",
        
        // Doppler Tecidual templates  
        tecidual_normal: "Velocidades do Doppler tecidual dentro dos limites da normalidade. Rela√ß√£o E/e' normal.",
        tecidual_alterado: "Altera√ß√£o das velocidades do Doppler tecidual. Rela√ß√£o E/e' aumentada, sugerindo eleva√ß√£o das press√µes de enchimento.",
        
        // Conclus√£o templates
        conclusao_normal: "Ecocardiograma transtor√°cico dentro dos limites da normalidade. Fun√ß√£o sist√≥lica global e segmentar do ventr√≠culo esquerdo preservadas. Aus√™ncia de altera√ß√µes valvares significativas.",
        conclusao_alteracoes: "Ecocardiograma transtor√°cico evidenciando altera√ß√µes estruturais e/ou funcionais. Fun√ß√£o sist√≥lica global do ventr√≠culo esquerdo comprometida/preservada.",
        conclusao_acompanhamento: "Ecocardiograma transtor√°cico com altera√ß√µes que necessitam acompanhamento cl√≠nico e ecocardiogr√°fico seriado."
    };

    // Character counters usando JavaScript nativo
    function updateCharCount(textareaId, counterId) {
        const textarea = document.getElementById(textareaId);
        const counter = document.getElementById(counterId);
        if (!textarea || !counter) return;
        
        const maxLength = textarea.getAttribute('maxlength');
        
        function update() {
            const length = textarea.value.length;
            counter.textContent = length;
            
            // Reset classes
            counter.className = counter.className.replace(/text-(warning|danger)/g, '');
            
            if (length > maxLength * 0.9) {
                counter.classList.add('text-warning');
            }
            
            if (length >= maxLength) {
                counter.classList.remove('text-warning');
                counter.classList.add('text-danger');
            }
        }
        
        textarea.addEventListener('input', update);
        update();
    }

    // Initialize character counters
    updateCharCount('modo_m_bidimensional', 'modo_m_count');
    updateCharCount('doppler_convencional', 'doppler_count');
    updateCharCount('doppler_tecidual', 'tecidual_count');
    updateCharCount('conclusao', 'conclusao_count');

    // Template buttons usando JavaScript nativo
    document.querySelectorAll('.template-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const templateKey = this.getAttribute('data-template');
            const template = templates[templateKey];
            
            if (template) {
                // Find the nearest textarea
                const cardBody = this.closest('.card-body');
                const textarea = cardBody.querySelector('textarea');
                const currentText = textarea.value.trim();
                
                if (currentText === '') {
                    textarea.value = template;
                } else {
                    if (confirm('Substituir o texto atual pelo template?')) {
                        textarea.value = template;
                    }
                }
                
                // Trigger input event to update character count
                textarea.dispatchEvent(new Event('input'));
                updatePreview();
            }
        });
    });

    // Auto-save functionality usando JavaScript nativo
    let autoSaveTimer;
    
    function autoSave() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(function() {
            const form = document.getElementById('laudo-form');
            const formData = new FormData(form);
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    showAutoSaveIndicator();
                }
            })
            .catch(error => {
                console.log('Auto-save failed:', error);
            });
        }, 3000);
    }
    
    function showAutoSaveIndicator() {
        const indicator = document.getElementById('auto-save-indicator');
        if (indicator) {
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
    }

    // Trigger auto-save on text change usando JavaScript nativo
    document.querySelectorAll('textarea[data-auto-save="true"]').forEach(function(textarea) {
        textarea.addEventListener('input', function() {
            autoSave();
            updatePreview();
        });
    });

    // Update preview usando JavaScript nativo
    function updatePreview() {
        const preview = document.getElementById('laudo-preview');
        if (!preview) return; // Exit if preview element doesn't exist
        
        let content = '';
        
        // Safely get values with null checks
        const modoM = document.getElementById('modo_m_bidimensional');
        const doppler = document.getElementById('doppler_convencional');
        const tecidual = document.getElementById('doppler_tecidual');
        const conclusao = document.getElementById('conclusao');
        
        // Trim only if values exist
        const modoMText = modoM && modoM.value ? modoM.value.trim() : '';
        const dopplerText = doppler && doppler.value ? doppler.value.trim() : '';
        const tecidualText = tecidual && tecidual.value ? tecidual.value.trim() : '';
        const conclusaoText = conclusao && conclusao.value ? conclusao.value.trim() : '';
        
        if (modoMText) {
            content += '<h6 class="text-primary">Modo M e Bidimensional:</h6><p>' + modoMText + '</p>';
        }
        
        if (dopplerText) {
            content += '<h6 class="text-primary">Doppler Convencional:</h6><p>' + dopplerText + '</p>';
        }
        
        if (tecidualText) {
            content += '<h6 class="text-primary">Doppler Tecidual:</h6><p>' + tecidualText + '</p>';
        }
        
        if (conclusaoText) {
            content += '<h6 class="text-success">Conclus√£o:</h6><p><strong>' + conclusaoText + '</strong></p>';
        }
        
        if (content) {
            preview.innerHTML = content;
        } else {
            preview.innerHTML = '<p class="text-muted text-center">A pr√©via ser√° exibida conforme voc√™ preenche os campos acima.</p>';
        }
    }

    // Initial preview update
    updatePreview();

    // Form validation usando JavaScript nativo
    const form = document.getElementById('laudo-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const conclusaoElement = document.getElementById('conclusao');
            if (!conclusaoElement) return true; // Skip validation if element doesn't exist
            
            const conclusaoText = conclusaoElement.value ? conclusaoElement.value.trim() : '';
            
            if (!conclusaoText) {
                e.preventDefault();
                alert('A conclus√£o √© obrigat√≥ria para finalizar o laudo.');
                conclusaoElement.focus();
                return false;
            }
        });
    }

    // Busca de templates em tempo real usando JavaScript nativo
    const buscaInput = document.getElementById('busca-template-laudo');
    if (buscaInput) {
        buscaInput.addEventListener('input', debounce(buscarTemplatesLaudo, 300));
    }
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function buscarTemplatesLaudo() {
    const buscaInput = document.getElementById('busca-template-laudo');
    const categoriaSelect = document.getElementById('filtro-categoria-template');
    const templatesDiv = document.getElementById('templates-encontrados');
    
    if (!buscaInput || !templatesDiv) return;
    
    const busca = buscaInput.value.trim();
    const categoria = categoriaSelect ? categoriaSelect.value : '';
    
    if (busca.length < 2 && !categoria) {
        templatesDiv.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-search fa-2x mb-2"></i>
                <p>Digite pelo menos 2 caracteres para buscar</p>
            </div>
        `;
        return;
    }
    
    const params = new URLSearchParams();
    if (busca) params.append('q', busca);
    if (categoria) params.append('categoria', categoria);
    
    templatesDiv.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <span class="ms-2">Buscando templates...</span>
        </div>
    `;
    
    fetch('/api/buscar-laudos-templates?' + params.toString())
        .then(response => response.json())
        .then(data => {
            if (data && Array.isArray(data)) {
                renderizarTemplatesEncontrados(data);
            } else {
                templatesDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Nenhum template encontrado
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Erro ao buscar templates:', error);
            templatesDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    Erro de conex√£o ao buscar templates
                </div>
            `;
        });
}

function renderizarTemplatesEncontrados(templates) {
    const container = document.getElementById('templates-encontrados');
    if (!container) return;
    
    if (templates.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-file-medical fa-2x mb-2"></i>
                <p>Nenhum template encontrado</p>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="abrirGerenciadorTemplates()">
                    Criar Novo Template
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    templates.forEach(template => {
        html += `
            <div class="card mb-2 template-result" style="cursor: pointer;" onclick="aplicarTemplateLaudo(${template.id})">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 text-primary">${template.diagnostico || template.nome}</h6>
                            <small class="text-muted">
                                <span class="badge bg-light text-dark me-1">${template.categoria}</span>
                                ${template.favorito ? '<i class="fas fa-star text-warning ms-1"></i>' : ''}
                            </small>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="event.stopPropagation(); aplicarTemplateLaudo(${template.id})">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function aplicarTemplateLaudo(templateId) {
    fetch(`/api/laudos_templates/${templateId}`)
        .then(response => response.json())
        .then(data => {
            if (data) {
                const template = data;
                
                // Confirmar aplica√ß√£o
                if (confirm(`Aplicar template "${template.diagnostico}"? Os textos atuais ser√£o substitu√≠dos.`)) {
                    // Aplicar conte√∫do aos campos
                    if (template.modo_m_bidimensional) {
                        const modoMField = document.getElementById('modo_m_bidimensional');
                        if (modoMField) {
                            modoMField.value = template.modo_m_bidimensional;
                            modoMField.dispatchEvent(new Event('input'));
                        }
                    }
                    if (template.doppler_convencional) {
                        const dopplerField = document.getElementById('doppler_convencional');
                        if (dopplerField) {
                            dopplerField.value = template.doppler_convencional;
                            dopplerField.dispatchEvent(new Event('input'));
                        }
                    }
                    if (template.doppler_tecidual) {
                        const tecidualField = document.getElementById('doppler_tecidual');
                        if (tecidualField) {
                            tecidualField.value = template.doppler_tecidual;
                            tecidualField.dispatchEvent(new Event('input'));
                        }
                    }
                    if (template.conclusao) {
                        const conclusaoField = document.getElementById('conclusao');
                        if (conclusaoField) {
                            conclusaoField.value = template.conclusao;
                            conclusaoField.dispatchEvent(new Event('input'));
                        }
                    }
                    
                    // Atualizar preview
                    updatePreview();
                    
                    // Mostrar sucesso
                    mostrarNotificacao('success', `Template "${template.diagnostico}" aplicado com sucesso!`);
                    
                    // Auto-save
                    autoSave();
                }
            } else {
                mostrarNotificacao('error', 'Erro ao carregar template');
            }
        })
        .catch(error => {
            console.error('Erro ao aplicar template:', error);
            mostrarNotificacao('error', 'Erro de conex√£o ao carregar template');
        });
}

function abrirGerenciadorTemplates() {
    window.open('/templates-laudo', '_blank', 'width=1200,height=800');
}

function salvarComoTemplate() {
    const nome = prompt('Nome do template:');
    if (!nome || nome.trim() === '') return;
    
    const diagnostico = prompt('Diagn√≥stico:') || 'Ecocardiograma Normal';
    const categoria = prompt('Categoria (opcional):') || 'Normal';
    
    criarTemplateDireto(nome.trim(), diagnostico, categoria);
}

function criarTemplateDireto(nome, diagnostico, categoria) {
    const templateData = {
        categoria: categoria,
        diagnostico: diagnostico,
        modo_m_bidimensional: document.getElementById('modo_m_bidimensional')?.value || '',
        doppler_convencional: document.getElementById('doppler_convencional')?.value || '',
        doppler_tecidual: document.getElementById('doppler_tecidual')?.value || '',
        conclusao: document.getElementById('conclusao')?.value || ''
    };
    
    fetch('/api/salvar-template-laudo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(templateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarNotificacao('success', 'Template salvo com sucesso!');
        } else {
            mostrarNotificacao('error', 'Erro ao salvar template: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro ao salvar template:', error);
        mostrarNotificacao('error', 'Erro de conex√£o ao salvar template');
    });
}

// Fun√ß√£o de notifica√ß√£o nativa
function mostrarNotificacao(tipo, mensagem) {
    const alertClass = tipo === 'success' ? 'alert-success' : 
                     tipo === 'error' ? 'alert-danger' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

function criarTemplate(nome, patologiaId) {
    const data = {
        nome: nome,
        patologia_id: patologiaId,
        modo_m_bidimensional: $('#modo_m_bidimensional').val(),
        doppler_convencional: $('#doppler_convencional').val(),
        doppler_tecidual: $('#doppler_tecidual').val(),
        conclusao: $('#conclusao').val(),
        publico: false,
        favorito: false
    };
    
    $.ajax({
        url: '/api/templates-laudo',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                mostrarNotificacao('success', 'Template salvo com sucesso!');
                $('#busca-template-laudo').val('');
                $('#templates-encontrados').html(`
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <p>Template "${nome}" salvo!</p>
                    </div>
                `);
            } else {
                mostrarNotificacao('error', 'Erro ao salvar template: ' + response.error);
            }
        },
        error: function() {
            mostrarNotificacao('error', 'Erro de conex√£o ao salvar template');
        }
    });
}

function mostrarNotificacao(tipo, mensagem) {
    const classe = tipo === 'success' ? 'alert-success' : 'alert-danger';
    const icone = tipo === 'success' ? 'check-circle' : 'exclamation-triangle';
    
    const alerta = $(`
        <div class="alert ${classe} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 1060; min-width: 300px;">
            <i class="fas fa-${icone} me-2"></i>
            ${mensagem}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('body').append(alerta);
    
    // Auto-remove ap√≥s 5 segundos
    setTimeout(() => {
        alerta.alert('close');
    }, 5000);
}

// Fun√ß√£o global para ser chamada pela janela de gerenciamento
window.aplicarTemplateLaudo = aplicarTemplateLaudo;

// ========================================
// FUNCIONALIDADE DE BUSCA DE LAUDOS M√âDICOS
// ========================================

let templateSelecionadoId = null;
let timeoutBusca = null;

$(document).ready(function() {
    // Inicializar busca de laudos m√©dicos
    $('#busca-laudo-diagnostico').on('input', function() {
        clearTimeout(timeoutBusca);
        const query = $(this).val().trim();
        
        if (query.length >= 2) {
            timeoutBusca = setTimeout(() => {
                buscarLaudosMedicos(query);
            }, 300);
        } else {
            $('#resultados-busca-laudo').hide();
            $('#template-selecionado').hide();
        }
    });
    
    // Limpar busca
    $('#limpar-busca-laudo').click(function() {
        $('#busca-laudo-diagnostico').val('');
        $('#resultados-busca-laudo').hide();
        $('#template-selecionado').hide();
        templateSelecionadoId = null;
    });
    
    // Aplicar template selecionado
    $('#aplicar-template').click(function() {
        if (templateSelecionadoId) {
            aplicarLaudoTemplate(templateSelecionadoId);
        }
    });
});

function buscarLaudosMedicos(query) {
    const categoria = $('#categoria-laudo').val();
    
    $.ajax({
        url: '/api/laudos_templates/buscar',
        method: 'GET',
        data: {
            q: query,
            categoria: categoria
        },
        success: function(templates) {
            if (templates && templates.length > 0) {
                renderizarResultadosLaudo(templates);
                $('#resultados-busca-laudo').show();
            } else {
                $('#resultados-busca-laudo').hide();
            }
            $('#template-selecionado').hide();
        },
        error: function() {
            mostrarNotificacao('error', 'Erro ao buscar templates de laudo');
        }
    });
}

function renderizarResultadosLaudo(templates) {
    const container = $('#lista-templates-laudo');
    let html = '';
    
    templates.forEach(template => {
        html += `
            <div class="col-md-6 mb-2">
                <div class="card h-100 template-card" style="cursor: pointer;" 
                     onclick="selecionarLaudoTemplate(${template.id}, '${template.diagnostico}')">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title text-primary mb-1">${template.diagnostico}</h6>
                                <p class="card-text text-muted small mb-2">
                                    <i class="fas fa-tag me-1"></i>${template.categoria}
                                </p>
                                <p class="card-text small text-truncate" style="max-height: 40px; overflow: hidden;">
                                    ${template.conclusao ? template.conclusao.substring(0, 80) + '...' : 'Laudo completo dispon√≠vel'}
                                </p>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm ms-2"
                                    onclick="event.stopPropagation(); selecionarLaudoTemplate(${template.id}, '${template.diagnostico}')">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.html(html);
}

function selecionarLaudoTemplate(templateId, diagnostico) {
    templateSelecionadoId = templateId;
    $('#nome-template-selecionado').text(diagnostico);
    $('#template-selecionado').show();
    
    // Destacar template selecionado
    $('.template-card').removeClass('border-success');
    $(event.currentTarget).closest('.template-card').addClass('border-success');
}

function aplicarLaudoTemplate(templateId) {
    $.ajax({
        url: `/api/laudos_templates/${templateId}`,
        method: 'GET',
        success: function(template) {
            if (template && !template.erro) {
                // Confirmar aplica√ß√£o
                if (confirm(`Aplicar template "${template.diagnostico}"?\n\nOs textos atuais ser√£o substitu√≠dos pelos dados do template.`)) {
                    // Aplicar conte√∫do aos campos
                    if (template.modo_m_bidimensional) {
                        $('#modo_m_bidimensional').val(template.modo_m_bidimensional);
                        updateCharCount('#modo_m_bidimensional');
                    }
                    
                    if (template.doppler_convencional) {
                        $('#doppler_convencional').val(template.doppler_convencional);
                        updateCharCount('#doppler_convencional');
                    }
                    
                    if (template.doppler_tecidual) {
                        $('#doppler_tecidual').val(template.doppler_tecidual);
                        updateCharCount('#doppler_tecidual');
                    }
                    
                    if (template.conclusao) {
                        $('#conclusao').val(template.conclusao);
                        updateCharCount('#conclusao');
                    }
                    
                    // Atualizar preview se existir
                    if (typeof updatePreview === 'function') {
                        updatePreview();
                    }
                    
                    // Auto-save se dispon√≠vel
                    if (typeof autoSave === 'function') {
                        autoSave();
                    }
                    
                    // Mostrar sucesso
                    mostrarNotificacao('success', `Template "${template.diagnostico}" aplicado com sucesso!`);
                    
                    // Ocultar sele√ß√£o
                    $('#template-selecionado').hide();
                    $('#resultados-busca-laudo').hide();
                    $('#busca-laudo-diagnostico').val('');
                }
            } else {
                mostrarNotificacao('error', 'Erro ao carregar template: ' + (template.erro || 'Template n√£o encontrado'));
            }
        },
        error: function() {
            mostrarNotificacao('error', 'Erro de conex√£o ao carregar template');
        }
    });
}

function updateCharCount(selector) {
    const textarea = $(selector);
    const currentLength = textarea.val().length;
    const maxLength = textarea.attr('maxlength') || 5000;
    const counter = textarea.siblings('.char-counter');
    
    if (counter.length) {
        counter.text(`${currentLength}/${maxLength} caracteres`);
        
        if (currentLength > maxLength * 0.9) {
            counter.addClass('text-warning');
        } else {
            counter.removeClass('text-warning');
        }
    }
}

// Fun√ß√£o para salvar laudo e gerar PDF
function salvarEGerarPDF(exameId) {
    console.log('üîÑ Salvando laudo e gerando PDF para exame:', exameId);
    
    const form = document.getElementById('laudo-form');
    const formData = new FormData(form);
    
    fetch(`/salvar_laudo/${exameId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            console.log('‚úÖ Laudo salvo com sucesso');
            
            // Gerar o PDF
            window.open(`/gerar-pdf/${exameId}`, '_blank');
            
            // Mostrar mensagem de sucesso
            alert('Laudo salvo e PDF gerado com sucesso!');
        } else {
            throw new Error('Erro no salvamento');
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao salvar laudo:', error);
        alert('Erro ao salvar laudo. Tente novamente.');
    });
}

</script>
{% endblock %}
