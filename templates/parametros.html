{% extends "base.html" %}

{% block title %}Parâmetros Ecocardiográficos - {{ exame.nome_paciente }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/debug_calculos.css') }}">
<style>
.parameter-section {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
    background: #fff;
}

.parameter-section-header {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    color: #1e40af;
    padding: 1rem;
    border-radius: 0.375rem 0.375rem 0 0;
    margin-bottom: 0;
    border-bottom: 2px solid #bfdbfe;
    font-weight: 700;
}

.parameter-section-body {
    padding: 1.5rem;
}

.form-floating input:focus {
    border-color: #41828e;
    box-shadow: 0 0 0 0.2rem rgba(65, 130, 142, 0.25);
}

.reference-value {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.calculated-field {
    background-color: #f8f9fa;
    border: 1px dashed #dee2e6;
}

.progress-indicator {
    background: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 2rem;
}

.progress-step {
    display: inline-flex;
    align-items: center;
    margin-right: 2rem;
    color: #6c757d;
}

.progress-step.active {
    color: #0a2853;
    font-weight: 600;
}

.progress-step.completed {
    color: #28a745;
}

.progress-step i {
    margin-right: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Progress Indicator -->
<div class="progress-indicator">
    <div class="d-flex flex-wrap">
        <div class="progress-step completed">
            <i class="fas fa-check-circle"></i>
            Dados do Paciente
        </div>
        <div class="progress-step active">
            <i class="fas fa-heartbeat"></i>
            Parâmetros Ecocardiográficos
        </div>
        <div class="progress-step">
            <i class="fas fa-file-medical"></i>
            Laudo
        </div>
        <div class="progress-step">
            <i class="fas fa-file-pdf"></i>
            Relatório Final
        </div>
    </div>
</div>

<!-- Patient Info -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h4 class="text-primary mb-1">{{ exame.nome_paciente }}</h4>
                <p class="text-muted mb-0">
                    <i class="fas fa-user me-1"></i>{{ exame.sexo }} • 
                    <i class="fas fa-birthday-cake me-1"></i>{{ exame.idade }} anos • 
                    <i class="fas fa-calendar me-1"></i>Exame: {{ exame.data_exame }}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{{ url_for('visualizar_exame', exame_id=exame.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye me-1"></i>Visualizar Exame
                </a>
            </div>
        </div>
    </div>
</div>

<form method="POST" id="parametros-form" action="{{ url_for('salvar_parametros', id=exame.id) }}">
    <!-- Dados Antropométricos -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-weight me-2"></i>Dados Antropométricos
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="peso" name="peso" 
                               value="{{ parametros.peso if parametros and parametros.peso else '' }}" 
                               placeholder="Peso">
                        <label for="peso">Peso (kg)</label>
                        <div class="reference-value">Valor medido</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="altura" name="altura" 
                               value="{{ parametros.altura if parametros and parametros.altura else '' }}" 
                               placeholder="Altura">
                        <label for="altura">Altura (cm)</label>
                        <div class="reference-value">Valor medido</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" id="superficie_corporal" 
                               name="superficie_corporal" 
                               value="{{ parametros.superficie_corporal if parametros and parametros.superficie_corporal else '' }}" 
                               placeholder="Superfície Corporal" readonly>
                        <label for="superficie_corporal">Superfície Corporal (m²)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="frequencia_cardiaca" name="frequencia_cardiaca" 
                               value="{{ parametros.frequencia_cardiaca if parametros and parametros.frequencia_cardiaca else '' }}" 
                               placeholder="FC">
                        <label for="frequencia_cardiaca">Frequência Cardíaca (bpm)</label>
                        <div class="reference-value">Normal: 60-100 bpm</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medidas Ecocardiográficas Básicas -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-ruler me-2"></i>Medidas Ecocardiográficas Básicas
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="atrio_esquerdo" name="atrio_esquerdo" 
                               value="{{ parametros.atrio_esquerdo if parametros and parametros.atrio_esquerdo else '36' }}" 
                               placeholder="AE">
                        <label for="atrio_esquerdo">Átrio Esquerdo (mm)</label>
                        <div class="reference-value">Normal: 27-38 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="raiz_aorta" name="raiz_aorta" 
                               value="{{ parametros.raiz_aorta if parametros and parametros.raiz_aorta else '35' }}" 
                               placeholder="Raiz Ao">
                        <label for="raiz_aorta">Raiz da Aorta (mm)</label>
                        <div class="reference-value">Normal: 21-34 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" 
                               id="relacao_atrio_esquerdo_aorta" name="relacao_atrio_esquerdo_aorta" 
                               value="{{ parametros.relacao_atrio_esquerdo_aorta if parametros and parametros.relacao_atrio_esquerdo_aorta else '' }}" 
                               placeholder="Relação AE/Ao" readonly>
                        <label for="relacao_atrio_esquerdo_aorta">Relação AE/Ao</label>
                        <div class="reference-value">Normal: &lt;1,5</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="aorta_ascendente" name="aorta_ascendente" 
                               value="{{ parametros.aorta_ascendente if parametros and parametros.aorta_ascendente else '33' }}" 
                               placeholder="Aorta Ascendente">
                        <label for="aorta_ascendente">Aorta Ascendente (mm)</label>
                        <div class="reference-value">Normal: &lt;38 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_ventricular_direito" 
                               name="diametro_ventricular_direito" 
                               value="{{ parametros.diametro_ventricular_direito if parametros and parametros.diametro_ventricular_direito else '18' }}" 
                               placeholder="Diâmetro VD">
                        <label for="diametro_ventricular_direito">Diâmetro VD (mm)</label>
                        <div class="reference-value">Normal: 7-23 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_basal_vd" name="diametro_basal_vd" 
                               value="{{ parametros.diametro_basal_vd if parametros and parametros.diametro_basal_vd else '32' }}" 
                               placeholder="Diâmetro Basal VD">
                        <label for="diametro_basal_vd">Diâmetro Basal VD (mm)</label>
                        <div class="reference-value">Normal: 25-41 mm</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ventrículo Esquerdo -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-heart me-2"></i>Ventrículo Esquerdo
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_diastolico_final_ve" 
                               name="diametro_diastolico_final_ve" 
                               value="{{ parametros.diametro_diastolico_final_ve if parametros and parametros.diametro_diastolico_final_ve else '45' }}" 
                               placeholder="DDVE">
                        <label for="diametro_diastolico_final_ve">DDVE (mm)</label>
                        <div class="reference-value">Normal: 35-56 mm</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_sistolico_final" 
                               name="diametro_sistolico_final" 
                               value="{{ parametros.diametro_sistolico_final if parametros and parametros.diametro_sistolico_final else '32' }}" 
                               placeholder="DSVE">
                        <label for="diametro_sistolico_final">DSVE (mm)</label>
                        <div class="reference-value">Normal: 21-40 mm</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" id="percentual_encurtamento" 
                               name="percentual_encurtamento" 
                               value="{{ parametros.percentual_encurtamento if parametros and parametros.percentual_encurtamento else '' }}" 
                               placeholder="% Encurtamento" readonly>
                        <label for="percentual_encurtamento">% Encurtamento</label>
                        <div class="reference-value">Normal: 25-45%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="espessura_diastolica_septo" 
                               name="espessura_diastolica_septo" 
                               value="{{ parametros.espessura_diastolica_septo if parametros and parametros.espessura_diastolica_septo else '9' }}" 
                               placeholder="Septo">
                        <label for="espessura_diastolica_septo">Septo (mm)</label>
                        <div class="reference-value">Normal: 6-11 mm</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="espessura_diastolica_ppve" 
                               name="espessura_diastolica_ppve" 
                               value="{{ parametros.espessura_diastolica_ppve if parametros and parametros.espessura_diastolica_ppve else '8' }}" 
                               placeholder="Parede Posterior">
                        <label for="espessura_diastolica_ppve">Parede Posterior (mm)</label>
                        <div class="reference-value">Normal: 6-11 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" 
                               id="relacao_septo_parede_posterior" name="relacao_septo_parede_posterior" 
                               value="{{ parametros.relacao_septo_parede_posterior if parametros and parametros.relacao_septo_parede_posterior else '' }}" 
                               placeholder="Relação Septo/PP" readonly>
                        <label for="relacao_septo_parede_posterior">Relação Septo/PP</label>
                        <div class="reference-value">Normal: &lt;1,3</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <!-- Volumes e Função Sistólica -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-area me-2"></i>Volumes e Função Sistólica
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="volume_diastolico_final" 
                               name="volume_diastolico_final" 
                               value="{{ parametros.volume_diastolico_final if parametros and parametros.volume_diastolico_final else '' }}" 
                               placeholder="VDF">
                        <label for="volume_diastolico_final">Volume Diastólico Final (mL)</label>
                        <div class="reference-value">Normal: 67-155 mL</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="volume_sistolico_final" 
                               name="volume_sistolico_final" 
                               value="{{ parametros.volume_sistolico_final if parametros and parametros.volume_sistolico_final else '' }}" 
                               placeholder="VSF">
                        <label for="volume_sistolico_final">Volume Sistólico Final (mL)</label>
                        <div class="reference-value">Normal: 22-58 mL</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="volume_ejecao" 
                               name="volume_ejecao" 
                               value="{{ parametros.volume_ejecao if parametros and parametros.volume_ejecao else '' }}" 
                               placeholder="Volume Ejeção" readonly>
                        <label for="volume_ejecao">Volume de Ejeção (mL)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="fracao_ejecao" 
                               name="fracao_ejecao" 
                               value="{{ parametros.fracao_ejecao if parametros and parametros.fracao_ejecao else '' }}" 
                               placeholder="FE" readonly>
                        <label for="fracao_ejecao">Fração de Ejeção (%)</label>
                        <div class="reference-value">Normal: ≥55%</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="massa_ve" 
                               name="massa_ve" 
                               value="{{ parametros.massa_ve if parametros and parametros.massa_ve else '' }}" 
                               placeholder="Massa VE" readonly>
                        <label for="massa_ve">Massa VE (g)</label>
                        <div class="reference-value">Normal: 67-162g (♀), 88-224g (♂)</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="indice_massa_ve" 
                               name="indice_massa_ve" 
                               value="{{ parametros.indice_massa_ve if parametros and parametros.indice_massa_ve else '' }}" 
                               placeholder="Índice Massa VE" readonly>
                        <label for="indice_massa_ve">Índice de Massa VE (g/m²)</label>
                        <div class="reference-value">Normal: 43-95g/m² (♀), 49-115g/m² (♂)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Velocidades dos Fluxos -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-tint me-2"></i>Velocidades dos Fluxos
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="fluxo_pulmonar" name="fluxo_pulmonar" 
                               value="{{ parametros.fluxo_pulmonar if parametros and parametros.fluxo_pulmonar else '1.0' }}" 
                               placeholder="Fluxo Pulmonar">
                        <label for="fluxo_pulmonar">Fluxo Pulmonar (m/s)</label>
                        <div class="reference-value">Normal: 0.6-0.9 m/s</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="fluxo_mitral" name="fluxo_mitral" 
                               value="{{ parametros.fluxo_mitral if parametros and parametros.fluxo_mitral else '0.9' }}" 
                               placeholder="Fluxo Mitral">
                        <label for="fluxo_mitral">Fluxo Mitral (m/s)</label>
                        <div class="reference-value">Normal: 0.6-1.3 m/s</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="fluxo_aortico" name="fluxo_aortico" 
                               value="{{ parametros.fluxo_aortico if parametros and parametros.fluxo_aortico else '1.0' }}" 
                               placeholder="Fluxo Aórtico">
                        <label for="fluxo_aortico">Fluxo Aórtico (m/s)</label>
                        <div class="reference-value">Normal: 1.0-1.7 m/s</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="fluxo_tricuspide" name="fluxo_tricuspide" 
                               value="{{ parametros.fluxo_tricuspide if parametros and parametros.fluxo_tricuspide else '0.5' }}" 
                               placeholder="Fluxo Tricúspide">
                        <label for="fluxo_tricuspide">Fluxo Tricúspide (m/s)</label>
                        <div class="reference-value">Normal: 0.3-0.7 m/s</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gradientes -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>Gradientes
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="gradiente_vd_ap" 
                               name="gradiente_vd_ap" 
                               value="{{ parametros.gradiente_vd_ap if parametros and parametros.gradiente_vd_ap else '' }}" 
                               placeholder="VD→AP" readonly>
                        <label for="gradiente_vd_ap">VD→AP (mmHg)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="gradiente_ae_ve" 
                               name="gradiente_ae_ve" 
                               value="{{ parametros.gradiente_ae_ve if parametros and parametros.gradiente_ae_ve else '' }}" 
                               placeholder="AE→VE" readonly>
                        <label for="gradiente_ae_ve">AE→VE (mmHg)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="gradiente_ve_ao" 
                               name="gradiente_ve_ao" 
                               value="{{ parametros.gradiente_ve_ao if parametros and parametros.gradiente_ve_ao else '' }}" 
                               placeholder="VE→AO" readonly>
                        <label for="gradiente_ve_ao">VE→AO (mmHg)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="gradiente_ad_vd" 
                               name="gradiente_ad_vd" 
                               value="{{ parametros.gradiente_ad_vd if parametros and parametros.gradiente_ad_vd else '' }}" 
                               placeholder="AD→VD" readonly>
                        <label for="gradiente_ad_vd">AD→VD/IT (mmHg)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="pressao_sistolica_vd" 
                               name="pressao_sistolica_vd" 
                               value="{{ parametros.pressao_sistolica_vd if parametros and parametros.pressao_sistolica_vd else '' }}" 
                               placeholder="PSAP" readonly>
                        <label for="pressao_sistolica_vd">PSAP (mmHg)</label>
                        <div class="reference-value">Normal: 15-30 mmHg</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="d-flex gap-3 justify-content-between flex-wrap">
                <button type="button" class="btn btn-outline-secondary" onclick="voltarPagina()">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </button>
                
                <div class="d-flex gap-2 flex-wrap">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Salvar Parâmetros
                    </button>
                    
                    <button type="button" class="btn btn-primary" onclick="confirmarGeracaoPDF()">
                        <i class="fas fa-file-pdf me-2"></i>Gerar PDF
                    </button>
                    
                    <a href="{{ url_for('laudo', exame_id=exame.id) }}" class="btn btn-info">
                        <i class="fas fa-file-medical me-2"></i>Continuar para Laudo
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}
{% block extra_js %}
<script>
/**
 * SISTEMA DE CÁLCULOS AUTOMÁTICOS - JAVASCRIPT INLINE COMPLETO
 * SOLUÇÃO DEFINITIVA PARA RENDER - NÃO DEPENDE DE ARQUIVOS EXTERNOS
 */

console.log('🚀 INICIANDO SISTEMA DE CÁLCULOS INLINE COMPLETO');

// ==========================================
// FUNÇÕES DE CÁLCULO MÉDICO
// ==========================================

function calculateBodySurface() {
    console.log('📏 Calculando superfície corporal...');
    
    const peso = parseFloat(document.getElementById('peso')?.value || 0);
    const altura = parseFloat(document.getElementById('altura')?.value || 0);
    
    if (peso > 0 && altura > 0) {
        // Fórmula DuBois: BSA = 0.007184 × altura^0.725 × peso^0.425
        const bsa = 0.007184 * Math.pow(altura, 0.725) * Math.pow(peso, 0.425);
        const superficieElement = document.getElementById('superficie_corporal');
        
        if (superficieElement) {
            superficieElement.value = bsa.toFixed(2);
            superficieElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Superfície corporal calculada: ${bsa.toFixed(2)} m²`);
        }
        
        // Recalcular massa VE que depende da superfície
        calculateLeftVentricularMassIndex();
    }
}

function calculateAtrioAortaRatio() {
    console.log('💓 Calculando relação AE/Ao...');
    
    const ae = parseFloat(document.getElementById('atrio_esquerdo')?.value || 0);
    const ao = parseFloat(document.getElementById('raiz_aorta')?.value || 0);
    
    if (ae > 0 && ao > 0) {
        const ratio = ae / ao;
        const ratioElement = document.getElementById('relacao_atrio_esquerdo_aorta');
        
        if (ratioElement) {
            ratioElement.value = ratio.toFixed(2);
            ratioElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Relação AE/Ao calculada: ${ratio.toFixed(2)}`);
        }
    }
}

function calculateShortening() {
    console.log('🔄 Calculando percentual de encurtamento...');
    
    const ddve = parseFloat(document.getElementById('diametro_diastolico_final_ve')?.value || 0);
    const dsve = parseFloat(document.getElementById('diametro_sistolico_final')?.value || 0);
    
    if (ddve > 0 && dsve > 0) {
        const shortening = ((ddve - dsve) / ddve) * 100;
        const shorteningElement = document.getElementById('percentual_encurtamento');
        
        if (shorteningElement) {
            shorteningElement.value = shortening.toFixed(1);
            shorteningElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Percentual de encurtamento calculado: ${shortening.toFixed(1)}%`);
        }
    }
}

function calculateSeptumWallRatio() {
    console.log('🧱 Calculando relação Septo/PP...');
    
    const septo = parseFloat(document.getElementById('espessura_diastolica_septo')?.value || 0);
    const pp = parseFloat(document.getElementById('espessura_diastolica_ppve')?.value || 0);
    
    if (septo > 0 && pp > 0) {
        const ratio = septo / pp;
        const ratioElement = document.getElementById('relacao_septo_parede_posterior');
        
        if (ratioElement) {
            ratioElement.value = ratio.toFixed(2);
            ratioElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Relação Septo/PP calculada: ${ratio.toFixed(2)}`);
        }
    }
}

function calculateDiastolicVolumeTeichholz() {
    console.log('📊 Calculando VDF (Teichholz)...');
    
    const ddve = parseFloat(document.getElementById('diametro_diastolico_final_ve')?.value || 0);
    
    if (ddve > 0) {
        // Método Teichholz: VDF = (7.0 / (2.4 + DDVE)) × DDVE³
        const vdf = (7.0 / (2.4 + (ddve / 10))) * Math.pow(ddve / 10, 3);
        const vdfElement = document.getElementById('volume_diastolico_final');
        
        if (vdfElement) {
            vdfElement.value = vdf.toFixed(1);
            vdfElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ VDF calculado: ${vdf.toFixed(1)} mL`);
        }
        
        // Recalcular volumes dependentes
        calculateSystolicVolumeTeichholz();
        calculateEjectionVolume();
        calculateEjectionFraction();
    }
}

function calculateSystolicVolumeTeichholz() {
    console.log('📊 Calculando VSF (Teichholz)...');
    
    const dsve = parseFloat(document.getElementById('diametro_sistolico_final')?.value || 0);
    
    if (dsve > 0) {
        // Método Teichholz: VSF = (7.0 / (2.4 + DSVE)) × DSVE³
        const vsf = (7.0 / (2.4 + (dsve / 10))) * Math.pow(dsve / 10, 3);
        const vsfElement = document.getElementById('volume_sistolico_final');
        
        if (vsfElement) {
            vsfElement.value = vsf.toFixed(1);
            vsfElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ VSF calculado: ${vsf.toFixed(1)} mL`);
        }
        
        // Recalcular volumes dependentes
        calculateEjectionVolume();
        calculateEjectionFraction();
    }
}

function calculateEjectionVolume() {
    console.log('💨 Calculando volume de ejeção...');
    
    const vdf = parseFloat(document.getElementById('volume_diastolico_final')?.value || 0);
    const vsf = parseFloat(document.getElementById('volume_sistolico_final')?.value || 0);
    
    if (vdf > 0 && vsf > 0) {
        const ve = vdf - vsf;
        const veElement = document.getElementById('volume_ejecao');
        
        if (veElement) {
            veElement.value = ve.toFixed(1);
            veElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Volume de ejeção calculado: ${ve.toFixed(1)} mL`);
        }
    }
}

function calculateEjectionFraction() {
    console.log('💯 Calculando fração de ejeção...');
    
    const vdf = parseFloat(document.getElementById('volume_diastolico_final')?.value || 0);
    const vsf = parseFloat(document.getElementById('volume_sistolico_final')?.value || 0);
    
    if (vdf > 0 && vsf > 0) {
        const fe = ((vdf - vsf) / vdf) * 100;
        const feElement = document.getElementById('fracao_ejecao');
        
        if (feElement) {
            feElement.value = fe.toFixed(1);
            feElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Fração de ejeção calculada: ${fe.toFixed(1)}%`);
        }
    }
}

function calculateLeftVentricularMass() {
    console.log('⚖️ Calculando massa VE...');
    
    const ddve = parseFloat(document.getElementById('diametro_diastolico_final_ve')?.value || 0);
    const septo = parseFloat(document.getElementById('espessura_diastolica_septo')?.value || 0);
    const pp = parseFloat(document.getElementById('espessura_diastolica_ppve')?.value || 0);
    
    if (ddve > 0 && septo > 0 && pp > 0) {
        // Fórmula ASE corrigida: Massa = 0.8 × (1.04 × [(DDVE + septo + PP)³ - DDVE³]) + 0.6
        const ddveCm = ddve / 10;
        const septoCm = septo / 10;
        const ppCm = pp / 10;
        
        const massa = 0.8 * (1.04 * (Math.pow(ddveCm + septoCm + ppCm, 3) - Math.pow(ddveCm, 3))) + 0.6;
        const massaElement = document.getElementById('massa_ve');
        
        if (massaElement) {
            massaElement.value = massa.toFixed(1);
            massaElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Massa VE calculada: ${massa.toFixed(1)} g`);
        }
        
        // Recalcular índice de massa
        calculateLeftVentricularMassIndex();
    }
}

function calculateLeftVentricularMassIndex() {
    console.log('📋 Calculando índice de massa VE...');
    
    const massa = parseFloat(document.getElementById('massa_ve')?.value || 0);
    const superficie = parseFloat(document.getElementById('superficie_corporal')?.value || 0);
    
    if (massa > 0 && superficie > 0) {
        const indice = massa / superficie;
        const indiceElement = document.getElementById('indice_massa_ve');
        
        if (indiceElement) {
            indiceElement.value = indice.toFixed(1);
            indiceElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Índice de massa VE calculado: ${indice.toFixed(1)} g/m²`);
        }
    }
}

function calculateGradientVDAP() {
    console.log('🌊 Calculando gradiente VD→AP...');
    
    const fluxo = parseFloat(document.getElementById('fluxo_pulmonar')?.value || 0);
    
    if (fluxo > 0) {
        // Equação de Bernoulli: ΔP = 4 × V²
        const gradiente = 4 * Math.pow(fluxo, 2);
        const gradienteElement = document.getElementById('gradiente_vd_ap');
        
        if (gradienteElement) {
            gradienteElement.value = gradiente.toFixed(1);
            gradienteElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Gradiente VD→AP calculado: ${gradiente.toFixed(1)} mmHg`);
        }
    }
}

function calculateGradientVEAO() {
    console.log('🌊 Calculando gradiente VE→AO...');
    
    const fluxo = parseFloat(document.getElementById('fluxo_aortico')?.value || 0);
    
    if (fluxo > 0) {
        // Equação de Bernoulli: ΔP = 4 × V²
        const gradiente = 4 * Math.pow(fluxo, 2);
        const gradienteElement = document.getElementById('gradiente_ve_ao');
        
        if (gradienteElement) {
            gradienteElement.value = gradiente.toFixed(1);
            gradienteElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Gradiente VE→AO calculado: ${gradiente.toFixed(1)} mmHg`);
        }
    }
}

function calculateGradientAEVE() {
    console.log('🌊 Calculando gradiente AE→VE...');
    
    const fluxo = parseFloat(document.getElementById('fluxo_mitral')?.value || 0);
    
    if (fluxo > 0) {
        // Equação de Bernoulli: ΔP = 4 × V²
        const gradiente = 4 * Math.pow(fluxo, 2);
        const gradienteElement = document.getElementById('gradiente_ae_ve');
        
        if (gradienteElement) {
            gradienteElement.value = gradiente.toFixed(1);
            gradienteElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Gradiente AE→VE calculado: ${gradiente.toFixed(1)} mmHg`);
        }
    }
}

function calculateGradientADVD() {
    console.log('🌊 Calculando gradiente AD→VD/IT...');
    
    const fluxo = parseFloat(document.getElementById('fluxo_tricuspide')?.value || 0);
    
    if (fluxo > 0) {
        // Equação de Bernoulli: ΔP = 4 × V²
        const gradiente = 4 * Math.pow(fluxo, 2);
        const gradienteElement = document.getElementById('gradiente_ad_vd');
        
        if (gradienteElement) {
            gradienteElement.value = gradiente.toFixed(1);
            gradienteElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ Gradiente AD→VD/IT calculado: ${gradiente.toFixed(1)} mmHg`);
        }
        
        // Calcular PSAP
        calculatePSAP();
    }
}

function calculatePSAP() {
    console.log('🫀 Calculando PSAP...');
    
    const gradienteIT = parseFloat(document.getElementById('gradiente_ad_vd')?.value || 0);
    
    if (gradienteIT > 0) {
        // PSAP = Gradiente IT + PVC estimada (assumindo PVC = 10 mmHg)
        const pvc = 10; // PVC estimada
        const psap = gradienteIT + pvc;
        const psapElement = document.getElementById('pressao_sistolica_vd');
        
        if (psapElement) {
            psapElement.value = psap.toFixed(1);
            psapElement.style.backgroundColor = '#e8f5e8';
            console.log(`✅ PSAP calculada: ${psap.toFixed(1)} mmHg`);
        }
    }
}

// ==========================================
// CONFIGURAÇÃO DE EVENT LISTENERS
// ==========================================

function setupAllEventListeners() {
    console.log('🔗 Configurando todos os event listeners...');
    
    // Superfície corporal
    addListener('peso', ['input', 'change'], calculateBodySurface);
    addListener('altura', ['input', 'change'], calculateBodySurface);
    
    // Relação AE/Ao
    addListener('atrio_esquerdo', ['input', 'change'], calculateAtrioAortaRatio);
    addListener('raiz_aorta', ['input', 'change'], calculateAtrioAortaRatio);
    
    // Ventrículo Esquerdo
    addListener('diametro_diastolico_final_ve', ['input', 'change'], function() {
        calculateShortening();
        calculateDiastolicVolumeTeichholz();
        calculateLeftVentricularMass();
    });
    
    addListener('diametro_sistolico_final', ['input', 'change'], function() {
        calculateShortening();
        calculateSystolicVolumeTeichholz();
    });
    
    addListener('espessura_diastolica_septo', ['input', 'change'], function() {
        calculateSeptumWallRatio();
        calculateLeftVentricularMass();
    });
    
    addListener('espessura_diastolica_ppve', ['input', 'change'], function() {
        calculateSeptumWallRatio();
        calculateLeftVentricularMass();
    });
    
    // Fluxos e Gradientes
    addListener('fluxo_pulmonar', ['input', 'change'], calculateGradientVDAP);
    addListener('fluxo_aortico', ['input', 'change'], calculateGradientVEAO);
    addListener('fluxo_mitral', ['input', 'change'], calculateGradientAEVE);
    addListener('fluxo_tricuspide', ['input', 'change'], calculateGradientADVD);
    
    console.log('✅ Todos os event listeners configurados');
}

function addListener(elementId, events, callback) {
    const element = document.getElementById(elementId);
    if (element) {
        events.forEach(event => {
            element.addEventListener(event, callback);
        });
        console.log(`✅ Listener adicionado para ${elementId}`);
    } else {
        console.warn(`⚠️ Elemento ${elementId} não encontrado`);
    }
}

// ==========================================
// FUNÇÕES AUXILIARES
// ==========================================

function executeAllCalculations() {
    console.log('🔄 Executando todos os cálculos...');
    
    calculateBodySurface();
    calculateAtrioAortaRatio();
    calculateShortening();
    calculateSeptumWallRatio();
    calculateDiastolicVolumeTeichholz();
    calculateSystolicVolumeTeichholz();
    calculateEjectionVolume();
    calculateEjectionFraction();
    calculateLeftVentricularMass();
    calculateLeftVentricularMassIndex();
    calculateGradientVDAP();
    calculateGradientVEAO();
    calculateGradientAEVE();
    calculateGradientADVD();
    calculatePSAP();
    
    console.log('✅ Todos os cálculos executados');
}

function voltarPagina() {
    console.log('🔙 Função voltarPagina chamada');
    
    try {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = '/';
        }
    } catch (error) {
        console.error('❌ Erro na função voltarPagina:', error);
        window.location.href = '/';
    }
}

function confirmarGeracaoPDF() {
    console.log('📄 Função confirmarGeracaoPDF chamada');
    
    const exameId = {{ exame.id }};
    
    if (confirm('Gerar PDF do exame? Certifique-se de que os dados estão salvos.')) {
        window.open(`/gerar-pdf/${exameId}`, '_blank');
    }
}

// ==========================================
// INDICADOR VISUAL DE STATUS
// ==========================================

function criarIndicadorStatus() {
    const badge = document.createElement('div');
    badge.id = 'badge-status-calculos';
    badge.innerHTML = '✅ Cálculos: Ativos (Inline)';
    badge.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        z-index: 1000;
        border: 2px solid #fff;
    `;
    document.body.appendChild(badge);
    console.log('✅ Indicador de status criado');
}

// ==========================================
// INICIALIZAÇÃO PRINCIPAL
// ==========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ DOM carregado - Inicializando sistema inline...');
    
    // Aguardar um momento para garantir que todos os elementos existam
    setTimeout(function() {
        setupAllEventListeners();
        executeAllCalculations();
        criarIndicadorStatus();
        
        console.log('🎯 SISTEMA DE CÁLCULOS INLINE TOTALMENTE OPERACIONAL!');
        
        // Expor funções globalmente para debug
        window.executeAllCalculations = executeAllCalculations;
        window.testarCalculos = executeAllCalculations;
        window.voltarPagina = voltarPagina;
        window.confirmarGeracaoPDF = confirmarGeracaoPDF;
        
    }, 1000);
});

// ==========================================
// DIAGNÓSTICO AUTOMÁTICO
// ==========================================

setTimeout(function() {
    console.log('🔍 === DIAGNÓSTICO AUTOMÁTICO ===');
    
    const camposTeste = ['peso', 'altura', 'superficie_corporal'];
    let camposEncontrados = 0;
    
    camposTeste.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (elemento) {
            camposEncontrados++;
            console.log(`✅ ${campo}: ENCONTRADO`);
        } else {
            console.error(`❌ ${campo}: NÃO ENCONTRADO`);
        }
    });
    
    console.log(`📊 STATUS: ${camposEncontrados}/${camposTeste.length} campos encontrados`);
    
    if (camposEncontrados === camposTeste.length) {
        console.log('🎉 SISTEMA 100% OPERACIONAL!');
    } else {
        console.warn('⚠️ Alguns campos não foram encontrados');
    }
    
    console.log('🏁 === FIM DO DIAGNÓSTICO ===');
}, 2000);

console.log('🚀 SISTEMA DE CÁLCULOS INLINE CARREGADO COMPLETAMENTE!');
</script>
{% endblock %}
