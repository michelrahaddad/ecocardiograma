{% extends "base.html" %}

{% block title %}Parâmetros Ecocardiográficos - {{ exame.nome_paciente }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/debug_calculos.css') }}">
<style>
.parameter-section {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
    background: #fff;
}

.parameter-section-header {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    color: #1e40af;
    padding: 1rem;
    border-radius: 0.375rem 0.375rem 0 0;
    margin-bottom: 0;
    border-bottom: 2px solid #bfdbfe;
    font-weight: 700;
}

.parameter-section-body {
    padding: 1.5rem;
}

.form-floating input:focus {
    border-color: #41828e;
    box-shadow: 0 0 0 0.2rem rgba(65, 130, 142, 0.25);
}

.reference-value {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.calculated-field {
    background-color: #f8f9fa;
    border: 1px dashed #dee2e6;
}

.progress-indicator {
    background: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 2rem;
}

.progress-step {
    display: inline-flex;
    align-items: center;
    margin-right: 2rem;
    color: #6c757d;
}

.progress-step.active {
    color: #0a2853;
    font-weight: 600;
}

.progress-step.completed {
    color: #28a745;
}

.progress-step i {
    margin-right: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Progress Indicator -->
<div class="progress-indicator">
    <div class="d-flex flex-wrap">
        <div class="progress-step completed">
            <i class="fas fa-check-circle"></i>
            Dados do Paciente
        </div>
        <div class="progress-step active">
            <i class="fas fa-heartbeat"></i>
            Parâmetros Ecocardiográficos
        </div>
        <div class="progress-step">
            <i class="fas fa-file-medical"></i>
            Laudo
        </div>
        <div class="progress-step">
            <i class="fas fa-file-pdf"></i>
            Relatório Final
        </div>
    </div>
</div>

<!-- Patient Info -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h4 class="text-primary mb-1">{{ exame.nome_paciente }}</h4>
                <p class="text-muted mb-0">
                    <i class="fas fa-user me-1"></i>{{ exame.sexo }} • 
                    <i class="fas fa-birthday-cake me-1"></i>{{ exame.idade }} anos • 
                    <i class="fas fa-calendar me-1"></i>Exame: {{ exame.data_exame }}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{{ url_for('visualizar_exame', id=exame.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye me-1"></i>Visualizar Exame
                </a>
            </div>
        </div>
    </div>
</div>

<form method="POST" id="parametros-form" action="{{ url_for('salvar_parametros', id=exame.id) }}">
    <!-- Dados Antropométricos -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-weight me-2"></i>Dados Antropométricos
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="peso" name="peso" 
                               value="{{ parametros.peso if parametros and parametros.peso else '' }}" 
                               placeholder="Peso">
                        <label for="peso">Peso (kg)</label>
                        <div class="reference-value">Valor medido</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="altura" name="altura" 
                               value="{{ parametros.altura if parametros and parametros.altura else '' }}" 
                               placeholder="Altura">
                        <label for="altura">Altura (cm)</label>
                        <div class="reference-value">Valor medido</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" id="superficie_corporal" 
                               name="superficie_corporal" 
                               value="{{ parametros.superficie_corporal if parametros and parametros.superficie_corporal else '' }}" 
                               placeholder="Superfície Corporal" readonly>
                        <label for="superficie_corporal">Superfície Corporal (m²)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="frequencia_cardiaca" name="frequencia_cardiaca" 
                               value="{{ parametros.frequencia_cardiaca if parametros and parametros.frequencia_cardiaca else '' }}" 
                               placeholder="FC">
                        <label for="frequencia_cardiaca">Frequência Cardíaca (bpm)</label>
                        <div class="reference-value">Normal: 60-100 bpm</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medidas Ecocardiográficas Básicas -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-ruler me-2"></i>Medidas Ecocardiográficas Básicas
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="atrio_esquerdo" name="atrio_esquerdo" 
                               value="{{ parametros.atrio_esquerdo if parametros and parametros.atrio_esquerdo else '36' }}" 
                               placeholder="AE">
                        <label for="atrio_esquerdo">Átrio Esquerdo (mm)</label>
                        <div class="reference-value">Normal: 27-38 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="raiz_aorta" name="raiz_aorta" 
                               value="{{ parametros.raiz_aorta if parametros and parametros.raiz_aorta else '35' }}" 
                               placeholder="Raiz Ao">
                        <label for="raiz_aorta">Raiz da Aorta (mm)</label>
                        <div class="reference-value">Normal: 21-34 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" 
                               id="relacao_atrio_esquerdo_aorta" name="relacao_atrio_esquerdo_aorta" 
                               value="{{ parametros.relacao_atrio_esquerdo_aorta if parametros and parametros.relacao_atrio_esquerdo_aorta else '' }}" 
                               placeholder="Relação AE/Ao" readonly>
                        <label for="relacao_atrio_esquerdo_aorta">Relação AE/Ao</label>
                        <div class="reference-value">Normal: &lt;1,5</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="aorta_ascendente" name="aorta_ascendente" 
                               value="{{ parametros.aorta_ascendente if parametros and parametros.aorta_ascendente else '33' }}" 
                               placeholder="Aorta Ascendente">
                        <label for="aorta_ascendente">Aorta Ascendente (mm)</label>
                        <div class="reference-value">Normal: &lt;38 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_ventricular_direito" 
                               name="diametro_ventricular_direito" 
                               value="{{ parametros.diametro_ventricular_direito if parametros and parametros.diametro_ventricular_direito else '18' }}" 
                               placeholder="Diâmetro VD">
                        <label for="diametro_ventricular_direito">Diâmetro VD (mm)</label>
                        <div class="reference-value">Normal: 7-23 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_basal_vd" name="diametro_basal_vd" 
                               value="{{ parametros.diametro_basal_vd if parametros and parametros.diametro_basal_vd else '32' }}" 
                               placeholder="Diâmetro Basal VD">
                        <label for="diametro_basal_vd">Diâmetro Basal VD (mm)</label>
                        <div class="reference-value">Normal: 25-41 mm</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ventrículo Esquerdo -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-heart me-2"></i>Ventrículo Esquerdo
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_diastolico_final_ve" 
                               name="diametro_diastolico_final_ve" 
                               value="{{ parametros.diametro_diastolico_final_ve if parametros and parametros.diametro_diastolico_final_ve else '45' }}" 
                               placeholder="DDVE">
                        <label for="diametro_diastolico_final_ve">DDVE (mm)</label>
                        <div class="reference-value">Normal: 35-56 mm</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_sistolico_final" 
                               name="diametro_sistolico_final" 
                               value="{{ parametros.diametro_sistolico_final if parametros and parametros.diametro_sistolico_final else '32' }}" 
                               placeholder="DSVE">
                        <label for="diametro_sistolico_final">DSVE (mm)</label>
                        <div class="reference-value">Normal: 21-40 mm</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" id="percentual_encurtamento" 
                               name="percentual_encurtamento" 
                               value="{{ parametros.percentual_encurtamento if parametros and parametros.percentual_encurtamento else '' }}" 
                               placeholder="% Encurtamento" readonly>
                        <label for="percentual_encurtamento">% Encurtamento</label>
                        <div class="reference-value">Normal: 25-45%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="espessura_diastolica_septo" 
                               name="espessura_diastolica_septo" 
                               value="{{ parametros.espessura_diastolica_septo if parametros and parametros.espessura_diastolica_septo else '9' }}" 
                               placeholder="Septo">
                        <label for="espessura_diastolica_septo">Septo (mm)</label>
                        <div class="reference-value">Normal: 6-11 mm</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="espessura_diastolica_ppve" 
                               name="espessura_diastolica_ppve" 
                               value="{{ parametros.espessura_diastolica_ppve if parametros and parametros.espessura_diastolica_ppve else '8' }}" 
                               placeholder="Parede Posterior">
                        <label for="espessura_diastolica_ppve">Parede Posterior (mm)</label>
                        <div class="reference-value">Normal: 6-11 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" 
                               id="relacao_septo_parede_posterior" name="relacao_septo_parede_posterior" 
                               value="{{ parametros.relacao_septo_parede_posterior if parametros and parametros.relacao_septo_parede_posterior else '' }}" 
                               placeholder="Relação Septo/PP" readonly>
                        <label for="relacao_septo_parede_posterior">Relação Septo/PP</label>
                        <div class="reference-value">Normal: &lt;1,3</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Volumes e Função Sistólica -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-area me-2"></i>Volumes e Função Sistólica
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="volume_diastolico_final" 
                               name="volume_diastolico_final" 
                               value="{{ parametros.volume_diastolico_final if parametros and parametros.volume_diastolico_final else '' }}" 
                               placeholder="VDF" readonly>
                        <label for="volume_diastolico_final">Volume Diastólico Final (mL)</label>
                        <div class="reference-value">Normal: 67-155 mL</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="volume_sistolico_final" 
                               name="volume_sistolico_final" 
                               value="{{ parametros.volume_sistolico_final if parametros and parametros.volume_sistolico_final else '' }}" 
                               placeholder="VSF" readonly>
                        <label for="volume_sistolico_final">Volume Sistólico Final (mL)</label>
                        <div class="reference-value">Normal: 22-58 mL</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="volume_ejecao" 
                               name="volume_ejecao" 
                               value="{{ parametros.volume_ejecao if parametros and parametros.volume_ejecao else '' }}" 
                               placeholder="Volume Ejeção" readonly>
                        <label for="volume_ejecao">Volume Ejeção (mL)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="fracao_ejecao" 
                               name="fracao_ejecao" 
                               value="{{ parametros.fracao_ejecao if parametros and parametros.fracao_ejecao else '' }}" 
                               placeholder="Fração Ejeção" readonly>
                        <label for="fracao_ejecao">Fração de Ejeção (%)</label>
                        <div class="reference-value">Normal: ≥55%</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="massa_ve" 
                               name="massa_ve" 
                               value="{{ parametros.massa_ve if parametros and parametros.massa_ve else '' }}" 
                               placeholder="Massa VE" readonly>
                        <label for="massa_ve">Massa VE (g)</label>
                        <div class="reference-value">H: 88-224g / M: 67-162g</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="indice_massa_ve" 
                               name="indice_massa_ve" 
                               value="{{ parametros.indice_massa_ve if parametros and parametros.indice_massa_ve else '' }}" 
                               placeholder="Índice Massa VE" readonly>
                        <label for="indice_massa_ve">Índice Massa VE (g/m²)</label>
                        <div class="reference-value">H: &lt;115 / M: &lt;95</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Velocidades dos Fluxos -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-water me-2"></i>Velocidades dos Fluxos
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="fluxo_pulmonar" name="fluxo_pulmonar" 
                               value="{{ parametros.fluxo_pulmonar if parametros and parametros.fluxo_pulmonar else '1.0' }}" 
                               placeholder="Fluxo Pulmonar">
                        <label for="fluxo_pulmonar">Fluxo Pulmonar (m/s)</label>
                        <div class="reference-value">Normal: 0.6-0.9 m/s</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="fluxo_mitral" name="fluxo_mitral" 
                               value="{{ parametros.fluxo_mitral if parametros and parametros.fluxo_mitral else '0.9' }}" 
                               placeholder="Fluxo Mitral">
                        <label for="fluxo_mitral">Fluxo Mitral (m/s)</label>
                        <div class="reference-value">Normal: 0.6-1.3 m/s</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="fluxo_aortico" name="fluxo_aortico" 
                               value="{{ parametros.fluxo_aortico if parametros and parametros.fluxo_aortico else '1.0' }}" 
                               placeholder="Fluxo Aórtico">
                        <label for="fluxo_aortico">Fluxo Aórtico (m/s)</label>
                        <div class="reference-value">Normal: 1.0-1.7 m/s</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="fluxo_tricuspide" name="fluxo_tricuspide" 
                               value="{{ parametros.fluxo_tricuspide if parametros and parametros.fluxo_tricuspide else '0.5' }}" 
                               placeholder="Fluxo Tricúspide">
                        <label for="fluxo_tricuspide">Fluxo Tricúspide (m/s)</label>
                        <div class="reference-value">Normal: &lt;2.8 m/s</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gradientes -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>Gradientes
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="gradiente_vd_ap" 
                               name="gradiente_vd_ap" 
                               value="{{ parametros.gradiente_vd_ap if parametros and parametros.gradiente_vd_ap else '' }}" 
                               placeholder="Gradiente VD→AP" readonly>
                        <label for="gradiente_vd_ap">Gradiente VD→AP (mmHg)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="gradiente_ae_ve" 
                               name="gradiente_ae_ve" 
                               value="{{ parametros.gradiente_ae_ve if parametros and parametros.gradiente_ae_ve else '' }}" 
                               placeholder="Gradiente AE→VE" readonly>
                        <label for="gradiente_ae_ve">Gradiente AE→VE (mmHg)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="gradiente_ve_ao" 
                               name="gradiente_ve_ao" 
                               value="{{ parametros.gradiente_ve_ao if parametros and parametros.gradiente_ve_ao else '' }}" 
                               placeholder="Gradiente VE→AO" readonly>
                        <label for="gradiente_ve_ao">Gradiente VE→AO (mmHg)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="gradiente_ad_vd" 
                               name="gradiente_ad_vd" 
                               value="{{ parametros.gradiente_ad_vd if parametros and parametros.gradiente_ad_vd else '' }}" 
                               placeholder="Gradiente AD→VD/IT" readonly>
                        <label for="gradiente_ad_vd">Gradiente AD→VD/IT (mmHg)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="pressao_sistolica_vd" 
                               name="pressao_sistolica_vd" 
                               value="{{ parametros.pressao_sistolica_vd if parametros and parametros.pressao_sistolica_vd else '' }}" 
                               placeholder="PSAP" readonly>
                        <label for="pressao_sistolica_vd">PSAP (mmHg)</label>
                        <div class="reference-value">Normal: &lt;30 mmHg</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex gap-3 justify-content-center">
                <button type="button" class="btn btn-secondary btn-lg" onclick="voltarPagina()">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </button>
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-save me-2"></i>Salvar Parâmetros
                </button>
                <button type="button" class="btn btn-primary btn-lg" onclick="confirmarGeracaoPDF()">
                    <i class="fas fa-file-pdf me-2"></i>Gerar PDF
                </button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/calculos_nativos.js') }}"></script>
<script src="{{ url_for('static', filename='js/calculos_backup_render.js') }}"></script>
<script>
// ==========================================
// DIAGNÓSTICO COMPLETO RENDER - CÁLCULOS AUTOMÁTICOS
// ==========================================

console.log('🔬 INICIANDO DIAGNÓSTICO COMPLETO DOS CÁLCULOS');

// 1. VERIFICAR CARREGAMENTO DO ARQUIVO JS
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ DOM CARREGADO - Iniciando diagnósticos...');
    
    setTimeout(function() {
        diagnosticarSistemaCalculos();
    }, 1000);
});

function diagnosticarSistemaCalculos() {
    console.log('🔍 === DIAGNÓSTICO SISTEMA DE CÁLCULOS ===');
    
    // 1. VERIFICAR FUNÇÕES GLOBAIS
    console.log('1. VERIFICANDO FUNÇÕES DISPONÍVEIS:');
    console.log('- initializeNativeCalculations:', typeof window.initializeNativeCalculations);
    console.log('- calculateBodySurface:', typeof window.calculateBodySurface);
    console.log('- executeAllCalculations:', typeof window.executeAllCalculations);
    
    // 2. VERIFICAR CAMPOS CRÍTICOS
    console.log('2. VERIFICANDO CAMPOS HTML:');
    const camposCriticos = [
        'peso', 'altura', 'superficie_corporal',
        'atrio_esquerdo', 'raiz_aorta', 'relacao_atrio_esquerdo_aorta',
        'diametro_diastolico_final_ve', 'diametro_sistolico_final',
        'volume_diastolico_final', 'volume_sistolico_final', 'fracao_ejecao'
    ];
    
    let camposEncontrados = 0;
    camposCriticos.forEach(function(campo) {
        const elemento = document.getElementById(campo);
        if (elemento) {
            camposEncontrados++;
            console.log(`✅ ${campo}: ENCONTRADO`);
        } else {
            console.error(`❌ ${campo}: NÃO ENCONTRADO`);
        }
    });
    
    console.log(`📊 CAMPOS ENCONTRADOS: ${camposEncontrados}/${camposCriticos.length}`);
    
    // 3. TESTAR CÁLCULO SIMPLES
    console.log('3. TESTE MANUAL DE CÁLCULO:');
    try {
        const peso = document.getElementById('peso');
        const altura = document.getElementById('altura');
        
        if (peso && altura) {
            // Simular valores
            peso.value = '70';
            altura.value = '170';
            
            console.log('📝 Valores de teste inseridos: peso=70, altura=170');
            
            // Tentar executar cálculo manual
            if (typeof calculateBodySurface === 'function') {
                calculateBodySurface();
                console.log('✅ Função calculateBodySurface executada');
                
                const superficie = document.getElementById('superficie_corporal');
                if (superficie && superficie.value) {
                    console.log(`🎯 SUCESSO! Superfície calculada: ${superficie.value} m²`);
                } else {
                    console.error('❌ Superfície não foi calculada');
                }
            } else {
                console.error('❌ Função calculateBodySurface não disponível');
            }
        }
    } catch (error) {
        console.error('❌ ERRO NO TESTE MANUAL:', error);
    }
    
    // 4. VERIFICAR EVENT LISTENERS
    console.log('4. VERIFICANDO EVENT LISTENERS:');
    try {
        const peso = document.getElementById('peso');
        if (peso) {
            const listeners = getEventListeners ? getEventListeners(peso) : 'N/A';
            console.log('Event listeners no campo peso:', listeners);
        }
    } catch (error) {
        console.log('Não foi possível verificar event listeners');
    }
    
    // 5. FORÇAR INICIALIZAÇÃO
    console.log('5. FORÇANDO INICIALIZAÇÃO:');
    try {
        if (typeof initializeNativeCalculations === 'function') {
            initializeNativeCalculations();
            console.log('✅ initializeNativeCalculations executada manualmente');
        } else {
            console.error('❌ initializeNativeCalculations não disponível');
        }
    } catch (error) {
        console.error('❌ ERRO na inicialização forçada:', error);
    }
    
    console.log('🏁 === FIM DO DIAGNÓSTICO ===');
}

// ==========================================
// FUNÇÃO UNIVERSAL VOLTAR PÁGINA
// ==========================================
function voltarPagina() {
    console.log('🔙 Função voltarPagina chamada');
    
    try {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = '/';
        }
    } catch (error) {
        console.error('❌ Erro na função voltarPagina:', error);
        window.location.href = '/';
    }
}

// ==========================================
// FUNÇÃO GERAR PDF
// ==========================================
function confirmarGeracaoPDF() {
    console.log('📄 Função confirmarGeracaoPDF chamada');
    
    const exameId = {{ exame.id }};
    
    if (confirm('Gerar PDF do exame? Certifique-se de que os dados estão salvos.')) {
        window.open(`/gerar-pdf/${exameId}`, '_blank');
    }
}

// ==========================================
// SISTEMA DE CÁLCULOS BACKUP (INLINE)
// ==========================================
function calcularSuperficieCorporalBackup() {
    console.log('🆘 USANDO SISTEMA BACKUP DE CÁLCULOS');
    
    const peso = parseFloat(document.getElementById('peso')?.value || 0);
    const altura = parseFloat(document.getElementById('altura')?.value || 0);
    
    if (peso > 0 && altura > 0) {
        const bsa = 0.007184 * Math.pow(altura, 0.725) * Math.pow(peso, 0.425);
        const superficieElement = document.getElementById('superficie_corporal');
        
        if (superficieElement) {
            superficieElement.value = bsa.toFixed(2);
            superficieElement.style.backgroundColor = '#e3f2fd';
            console.log(`🆘 BACKUP: Superfície calculada = ${bsa.toFixed(2)} m²`);
        }
    }
}

// Adicionar listeners backup
window.addEventListener('load', function() {
    console.log('🆘 Configurando sistema backup...');
    
    const peso = document.getElementById('peso');
    const altura = document.getElementById('altura');
    
    if (peso) peso.addEventListener('input', calcularSuperficieCorporalBackup);
    if (altura) altura.addEventListener('input', calcularSuperficieCorporalBackup);
});

// Expor função para teste manual
window.testarCalculos = diagnosticarSistemaCalculos;
window.calcularBackup = calcularSuperficieCorporalBackup;

// ==========================================
// INDICADOR VISUAL DE STATUS
// ==========================================
function criarIndicadorStatus() {
    const badge = document.createElement('div');
    badge.id = 'badge-status-calculos';
    badge.className = 'badge-calculos';
    badge.innerHTML = '🔄 Cálculos: Carregando...';
    document.body.appendChild(badge);
    
    // Atualizar status após testes
    setTimeout(function() {
        const superficie = document.getElementById('superficie_corporal');
        if (superficie && superficie.value) {
            badge.className = 'badge-calculos ativo';
            badge.innerHTML = '✅ Cálculos: Ativos';
        } else {
            badge.className = 'badge-calculos backup';
            badge.innerHTML = '🆘 Cálculos: Backup';
        }
    }, 3000);
}

// Criar indicador quando página carregar
window.addEventListener('load', criarIndicadorStatus);

// Função para testar tudo manualmente
window.testarTudoManual = function() {
    console.log('🧪 TESTE MANUAL COMPLETO');
    
    // 1. Testar diagnóstico
    diagnosticarSistemaCalculos();
    
    // 2. Testar backup
    if (window.testarBackupCalculos) {
        window.testarBackupCalculos();
    }
    
    // 3. Testar cálculo direto
    calcularSuperficieCorporalBackup();
    
    console.log('🏁 TESTE MANUAL FINALIZADO');
};

console.log('🚀 SISTEMA COMPLETO CARREGADO - Use window.testarTudoManual() para testar');
</script>
{% endblock %}
