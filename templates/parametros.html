{% extends "base.html" %}

{% block title %}Parâmetros Ecocardiográficos - {{ exame.nome_paciente }}{% endblock %}

{% block extra_css %}
<style>
.parameter-section {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
    background: #fff;
}

.parameter-section-header {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    color: #1e40af;
    padding: 1rem;
    border-radius: 0.375rem 0.375rem 0 0;
    margin-bottom: 0;
    border-bottom: 2px solid #bfdbfe;
    font-weight: 700;
}

.parameter-section-body {
    padding: 1.5rem;
}

.form-floating input:focus {
    border-color: #41828e;
    box-shadow: 0 0 0 0.2rem rgba(65, 130, 142, 0.25);
}

.reference-value {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.calculated-field {
    background-color: #f8f9fa;
    border: 1px dashed #dee2e6;
}

.progress-indicator {
    background: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 2rem;
}

.progress-step {
    display: inline-flex;
    align-items: center;
    margin-right: 2rem;
    color: #6c757d;
}

.progress-step.active {
    color: #0a2853;
    font-weight: 600;
}

.progress-step.completed {
    color: #28a745;
}

.progress-step i {
    margin-right: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Progress Indicator -->
<div class="progress-indicator">
    <div class="d-flex flex-wrap">
        <div class="progress-step completed">
            <i class="fas fa-check-circle"></i>
            Dados do Paciente
        </div>
        <div class="progress-step active">
            <i class="fas fa-heartbeat"></i>
            Parâmetros Ecocardiográficos
        </div>
        <div class="progress-step">
            <i class="fas fa-file-medical"></i>
            Laudo
        </div>
        <div class="progress-step">
            <i class="fas fa-file-pdf"></i>
            Relatório Final
        </div>
    </div>
</div>

<!-- Patient Info -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h4 class="text-primary mb-1">{{ exame.nome_paciente }}</h4>
                <p class="text-muted mb-0">
                    <i class="fas fa-user me-1"></i>{{ exame.sexo }} • 
                    <i class="fas fa-birthday-cake me-1"></i>{{ exame.idade }} anos • 
                    <i class="fas fa-calendar me-1"></i>Exame: {{ exame.data_exame }}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{{ url_for('visualizar_exame', exame_id=exame.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye me-1"></i>Visualizar Exame
                </a>
            </div>
        </div>
    </div>
</div>

<form method="POST" id="parametros-form" action="{{ url_for('salvar_parametros', id=exame.id) }}">
    <!-- Dados Antropométricos -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-weight me-2"></i>Dados Antropométricos
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="peso" name="peso" 
                               value="{{ parametros.peso if parametros and parametros.peso else '' }}" 
                               placeholder="Peso">
                        <label for="peso">Peso (kg)</label>
                        <div class="reference-value">Valor medido</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="altura" name="altura" 
                               value="{{ parametros.altura if parametros and parametros.altura else '' }}" 
                               placeholder="Altura">
                        <label for="altura">Altura (cm)</label>
                        <div class="reference-value">Valor medido</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" id="superficie_corporal" 
                               name="superficie_corporal" 
                               value="{{ parametros.superficie_corporal if parametros and parametros.superficie_corporal else '' }}" 
                               placeholder="Superfície Corporal" readonly>
                        <label for="superficie_corporal">Superfície Corporal (m²)</label>
                        <div class="reference-value">Calculado automaticamente</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="frequencia_cardiaca" name="frequencia_cardiaca" 
                               value="{{ parametros.frequencia_cardiaca if parametros and parametros.frequencia_cardiaca else '' }}" 
                               placeholder="FC">
                        <label for="frequencia_cardiaca">Frequência Cardíaca (bpm)</label>
                        <div class="reference-value">Normal: 60-100 bpm</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medidas Ecocardiográficas Básicas -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-ruler me-2"></i>Medidas Ecocardiográficas Básicas
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="atrio_esquerdo" name="atrio_esquerdo" 
                               value="{{ parametros.atrio_esquerdo if parametros and parametros.atrio_esquerdo else '36' }}" 
                               placeholder="AE">
                        <label for="atrio_esquerdo">Átrio Esquerdo (mm)</label>
                        <div class="reference-value">Normal: 27-38 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="raiz_aorta" name="raiz_aorta" 
                               value="{{ parametros.raiz_aorta if parametros and parametros.raiz_aorta else '35' }}" 
                               placeholder="Raiz Ao">
                        <label for="raiz_aorta">Raiz da Aorta (mm)</label>
                        <div class="reference-value">Normal: 21-34 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" 
                               id="relacao_atrio_esquerdo_aorta" name="relacao_atrio_esquerdo_aorta" 
                               value="{{ parametros.relacao_atrio_esquerdo_aorta if parametros and parametros.relacao_atrio_esquerdo_aorta else '' }}" 
                               placeholder="Relação AE/Ao" readonly>
                        <label for="relacao_atrio_esquerdo_aorta">Relação AE/Ao</label>
                        <div class="reference-value">Normal: &lt;1,5</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="aorta_ascendente" name="aorta_ascendente" 
                               value="{{ parametros.aorta_ascendente if parametros and parametros.aorta_ascendente else '33' }}" 
                               placeholder="Aorta Ascendente">
                        <label for="aorta_ascendente">Aorta Ascendente (mm)</label>
                        <div class="reference-value">Normal: &lt;38 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_ventricular_direito" 
                               name="diametro_ventricular_direito" 
                               value="{{ parametros.diametro_ventricular_direito if parametros and parametros.diametro_ventricular_direito else '18' }}" 
                               placeholder="Diâmetro VD">
                        <label for="diametro_ventricular_direito">Diâmetro VD (mm)</label>
                        <div class="reference-value">Normal: 7-23 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_basal_vd" name="diametro_basal_vd" 
                               value="{{ parametros.diametro_basal_vd if parametros and parametros.diametro_basal_vd else '32' }}" 
                               placeholder="Diâmetro Basal VD">
                        <label for="diametro_basal_vd">Diâmetro Basal VD (mm)</label>
                        <div class="reference-value">Normal: 25-41 mm</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ventrículo Esquerdo -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-heart me-2"></i>Ventrículo Esquerdo
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_diastolico_final_ve" 
                               name="diametro_diastolico_final_ve" 
                               value="{{ parametros.diametro_diastolico_final_ve if parametros and parametros.diametro_diastolico_final_ve else '45' }}" 
                               placeholder="DDVE">
                        <label for="diametro_diastolico_final_ve">DDVE (mm)</label>
                        <div class="reference-value">Normal: 35-56 mm</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="diametro_sistolico_final" 
                               name="diametro_sistolico_final" 
                               value="{{ parametros.diametro_sistolico_final if parametros and parametros.diametro_sistolico_final else '32' }}" 
                               placeholder="DSVE">
                        <label for="diametro_sistolico_final">DSVE (mm)</label>
                        <div class="reference-value">Normal: 21-40 mm</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" id="percentual_encurtamento" 
                               name="percentual_encurtamento" 
                               value="{{ parametros.percentual_encurtamento if parametros and parametros.percentual_encurtamento else '' }}" 
                               placeholder="% Encurtamento" readonly>
                        <label for="percentual_encurtamento">% Encurtamento</label>
                        <div class="reference-value">Normal: 25-45%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="espessura_diastolica_septo" 
                               name="espessura_diastolica_septo" 
                               value="{{ parametros.espessura_diastolica_septo if parametros and parametros.espessura_diastolica_septo else '9' }}" 
                               placeholder="Septo">
                        <label for="espessura_diastolica_septo">Septo (mm)</label>
                        <div class="reference-value">Normal: 6-11 mm</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="espessura_diastolica_ppve" 
                               name="espessura_diastolica_ppve" 
                               value="{{ parametros.espessura_diastolica_ppve if parametros and parametros.espessura_diastolica_ppve else '8' }}" 
                               placeholder="Parede Posterior">
                        <label for="espessura_diastolica_ppve">Parede Posterior (mm)</label>
                        <div class="reference-value">Normal: 6-11 mm</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control calculated-field" 
                               id="relacao_septo_parede_posterior" name="relacao_septo_parede_posterior" 
                               value="{{ parametros.relacao_septo_parede_posterior if parametros and parametros.relacao_septo_parede_posterior else '' }}" 
                               placeholder="Relação Septo/PP" readonly>
                        <label for="relacao_septo_parede_posterior">Relação Septo/PP</label>
                        <div class="reference-value">Normal: &lt;1,3</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Volumes e Função Sistólica -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-area me-2"></i>Volumes e Função Sistólica
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="volume_diastolico_final" 
                               name="volume_diastolico_final" 
                               value="{{ parametros.volume_diastolico_final if parametros and parametros.volume_diastolico_final else '' }}" 
                               placeholder="VDF">
                        <label for="volume_diastolico_final">Volume Diastólico Final (mL)</label>
                        <div class="reference-value">Normal: 67-155 mL</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="volume_sistolico_final" 
                               name="volume_sistolico_final" 
                               value="{{ parametros.volume_sistolico_final if parametros and parametros.volume_sistolico_final else '' }}" 
                               placeholder="VSF">
                        <label for="volume_sistolico_final">Volume Sistólico Final (mL)</label>
                        <div class="reference-value">Normal: 22-58 mL</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="volume_ejecao" 
                               name="volume_ejecao" 
                               value="{{ parametros.volume_ejecao if parametros and parametros.volume_ejecao else '' }}" 
                               placeholder="Volume de Ejeção" readonly>
                        <label for="volume_ejecao">Volume de Ejeção (mL)</label>
                        <div class="reference-value">Calculado: VDF - VSF</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="fracao_ejecao" 
                               name="fracao_ejecao" 
                               value="{{ parametros.fracao_ejecao if parametros and parametros.fracao_ejecao else '' }}" 
                               placeholder="Fração de Ejeção" readonly>
                        <label for="fracao_ejecao">Fração de Ejeção (%)</label>
                        <div class="reference-value">Normal: ≥55%</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="massa_ve" name="massa_ve" 
                               value="{{ parametros.massa_ve if parametros and parametros.massa_ve else '' }}" 
                               placeholder="Massa VE">
                        <label for="massa_ve">Massa VE (g)</label>
                        <div class="reference-value">Normal H: 88-224g, M: 67-162g</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="indice_massa_ve" 
                               name="indice_massa_ve" 
                               value="{{ parametros.indice_massa_ve if parametros and parametros.indice_massa_ve else '' }}" 
                               placeholder="Índice Massa VE" readonly>
                        <label for="indice_massa_ve">Índice Massa VE (g/m²)</label>
                        <div class="reference-value">Normal H: ≤115, M: ≤95 g/m²</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Velocidades dos Fluxos -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-wave-square me-2"></i>Velocidades dos Fluxos
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control" id="fluxo_pulmonar" name="fluxo_pulmonar" 
                               value="{{ parametros.fluxo_pulmonar if parametros and parametros.fluxo_pulmonar else '1.0' }}" 
                               placeholder="Fluxo Pulmonar">
                        <label for="fluxo_pulmonar">Fluxo Pulmonar (m/s)</label>
                        <div class="reference-value">Normal: 0,6-0,9 m/s</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control" id="fluxo_mitral" name="fluxo_mitral" 
                               value="{{ parametros.fluxo_mitral if parametros and parametros.fluxo_mitral else '0.9' }}" 
                               placeholder="Fluxo Mitral">
                        <label for="fluxo_mitral">Fluxo Mitral (m/s)</label>
                        <div class="reference-value">Normal: 0,6-1,3 m/s</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control" id="fluxo_aortico" name="fluxo_aortico" 
                               value="{{ parametros.fluxo_aortico if parametros and parametros.fluxo_aortico else '1.0' }}" 
                               placeholder="Fluxo Aórtico">
                        <label for="fluxo_aortico">Fluxo Aórtico (m/s)</label>
                        <div class="reference-value">Normal: 1,0-1,7 m/s</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control" id="fluxo_tricuspide" name="fluxo_tricuspide" 
                               value="{{ parametros.fluxo_tricuspide if parametros and parametros.fluxo_tricuspide else '0.5' }}" 
                               placeholder="Fluxo Tricúspide">
                        <label for="fluxo_tricuspide">Fluxo Tricúspide (m/s)</label>
                        <div class="reference-value">Normal: 0,3-0,7 m/s</div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- Gradientes -->
    <div class="parameter-section">
        <div class="parameter-section-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>Gradientes
            </h5>
        </div>
        <div class="parameter-section-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="gradiente_vd_ap" 
                               name="gradiente_vd_ap" 
                               value="{{ parametros.gradiente_vd_ap if parametros and parametros.gradiente_vd_ap else '' }}" 
                               placeholder="Gradiente VD→AP">
                        <label for="gradiente_vd_ap">Gradiente VD→AP (mmHg)</label>
                        <div class="reference-value">Normal: &lt;10 mmHg</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="gradiente_ae_ve" 
                               name="gradiente_ae_ve" 
                               value="{{ parametros.gradiente_ae_ve if parametros and parametros.gradiente_ae_ve else '' }}" 
                               placeholder="Gradiente AE→VE">
                        <label for="gradiente_ae_ve">Gradiente AE→VE (mmHg)</label>
                        <div class="reference-value">Normal: &lt;5 mmHg</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="gradiente_ve_ao" 
                               name="gradiente_ve_ao" 
                               value="{{ parametros.gradiente_ve_ao if parametros and parametros.gradiente_ve_ao else '' }}" 
                               placeholder="Gradiente VE→AO">
                        <label for="gradiente_ve_ao">Gradiente VE→AO (mmHg)</label>
                        <div class="reference-value">Normal: &lt;10 mmHg</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="gradiente_ad_vd" 
                               name="gradiente_ad_vd" 
                               value="{{ parametros.gradiente_ad_vd if parametros and parametros.gradiente_ad_vd else '' }}" 
                               placeholder="Gradiente AD→VD">
                        <label for="gradiente_ad_vd">Gradiente AD→VD (mmHg)</label>
                        <div class="reference-value">Normal: &lt;5 mmHg</div>
                    </div>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control" id="gradiente_tricuspide" 
                               name="gradiente_tricuspide" 
                               value="{{ parametros.gradiente_tricuspide if parametros and parametros.gradiente_tricuspide else '' }}" 
                               placeholder="Gradiente IT">
                        <label for="gradiente_tricuspide">Gradiente IT (mmHg)</label>
                        <div class="reference-value">Para cálculo da PSAP</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <input type="number" step="0.1" class="form-control calculated-field" id="pressao_sistolica_vd" 
                               name="pressao_sistolica_vd" 
                               value="{{ parametros.pressao_sistolica_vd if parametros and parametros.pressao_sistolica_vd else '' }}" 
                               placeholder="PSAP" readonly>
                        <label for="pressao_sistolica_vd">PSAP (mmHg)</label>
                        <div class="reference-value">Normal: &lt;35 mmHg</div>
                    </div>
                </div>
            </div>
        </div>
    </div>




    <!-- Buttons -->
    <div class="d-flex justify-content-between mt-4">
        <div>
            <a href="javascript:void(0)" onclick="voltarPagina(); return false;" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Voltar
            </a>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-1"></i>Salvar Parâmetros
            </button>
            <button type="submit" name="continuar_laudo" value="1" class="btn btn-primary">
                <i class="fas fa-arrow-right me-1"></i>Continuar para Laudo
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/calculos_nativos.js') }}"></script>
<script>
// ==========================================
// FUNÇÃO UNIVERSAL VOLTAR PÁGINA
// ==========================================
function voltarPagina() {
    console.log('🔙 Função voltarPagina chamada');
    
    try {
        // Verificar se há histórico disponível
        if (window.history.length > 1) {
            console.log('📚 Usando window.history.back()');
            window.history.back();
        } else {
            console.log('🏠 Redirecionando para página inicial (sem histórico)');
            window.location.href = '/';
        }
    } catch (error) {
        console.error('❌ Erro na função voltarPagina:', error);
        // Fallback absoluto
        window.location.href = '/';
    }
}

// ==========================================
// VERIFICAÇÃO DE CARREGAMENTO
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ JavaScript carregado - função voltarPagina disponível');
    console.log('🔍 Verificando botão Voltar...');
    
    const botaoVoltar = document.querySelector('[onclick*="voltarPagina"]');
    if (botaoVoltar) {
        console.log('✅ Botão Voltar encontrado:', botaoVoltar);
    } else {
        console.warn('⚠️ Botão Voltar não encontrado');
    }
});

// ==========================================
// TESTE DA FUNÇÃO (para debug)
// ==========================================
window.testarVoltarPagina = function() {
    console.log('🧪 Teste da função voltarPagina');
    voltarPagina();
};
</script>
{% endblock %}
